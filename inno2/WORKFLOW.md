# 工作流程说明

## 两种工作流程对比

### 🚀 基础流程（推荐，3步）

```
┌─────────────────────────────────────────────────────────┐
│ Step 1: prepare_data.py                                 │
│ ├─ 解压数据                                             │
│ └─ 生成 inno2.csv                                       │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│ Step 2: train_model.py                                  │
│ ├─ Phase A: 重构训练 (50 epochs)                        │
│ └─ Phase B: 特征对齐 (50 epochs)                        │
│ 输出: checkpoints/final_model.pth                       │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│ Step 3: inference.py ⭐                                 │
│ ├─ 生成红外图像                                         │
│ ├─ 计算残差 |IR - IR̂|                                  │
│ ├─ 生成热力图                                           │
│ └─ 输出异常分数                                         │
│ 输出: results/ (包含所有可视化结果)                     │
└─────────────────────────────────────────────────────────┘
                         ↓
                    ✅ 完成！
```

**异常检测方式**：
- 直接使用残差：`residual = |IR_real - IR_generated|`
- 简单、快速、有效
- 残差热力图直观显示异常位置

---

### 🎯 高级流程（可选，+1步）

```
┌─────────────────────────────────────────────────────────┐
│ Step 1-2: 同基础流程                                     │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│ Step 3: train_anomaly_detector.py (可选)                │
│ ├─ 方案1: 密度估计（高斯分布拟合）                       │
│ └─ 方案2: Teacher-Student（学习正常分布）               │
│ 输出: anomaly_models/detector.pth                       │
└─────────────────────────────────────────────────────────┘
                         ↓
┌─────────────────────────────────────────────────────────┐
│ Step 4: inference.py                                    │
│ ├─ 使用更精确的异常检测器                               │
│ └─ 提供更准确的异常分数                                 │
└─────────────────────────────────────────────────────────┘
                         ↓
                    ✅ 完成！
```

**异常检测方式**：
- 基于统计建模（马氏距离）
- 更精确的异常分数
- 更好的阈值自适应

---

## 核心问题：两个脚本的区别

### inference.py

| 特性 | 说明 |
|------|------|
| **功能** | 推理 + 基础异常检测 |
| **输入** | Phase B 模型 + 图像 |
| **异常检测** | 残差：`\|IR - IR̂\|` |
| **训练** | ❌ 不需要 |
| **速度** | ⚡ 快（~0.1秒/张） |
| **准确性** | ✓ 已足够 |
| **必需性** | ✅ **必需** |

### train_anomaly_detector.py

| 特性 | 说明 |
|------|------|
| **功能** | 训练专门的异常检测器 |
| **输入** | Phase B 模型 + 正常样本 |
| **异常检测** | 马氏距离/特征距离 |
| **训练** | ✅ 需要（~30分钟） |
| **速度** | ⚡ 推理仍快 |
| **准确性** | ✓✓ 更精确 |
| **必需性** | ⚠️ **可选** |

---

## 何时使用哪个？

### ✅ 使用基础流程（inference.py）如果：

1. ✓ 你是第一次使用
2. ✓ 需要快速验证模型效果
3. ✓ 残差热力图已经足够清晰
4. ✓ 不需要精确的异常分数排序
5. ✓ 项目时间紧迫

**推荐：** 90% 的场景下，基础流程已足够！

### ⚡ 使用高级流程（+ train_anomaly_detector.py）如果：

1. ✓ 需要对大量图像进行异常分数排序
2. ✓ 需要自动化阈值选择
3. ✓ 基础检测的假阳性率太高
4. ✓ 有充足的计算资源和时间
5. ✓ 需要发表论文展示更好的指标

---

## 实际示例

### 场景1：变电站巡检（基础流程）

```bash
# 工程师拍摄了一张可疑设备照片
python inference.py \
    --checkpoint final_model.pth \
    --visible suspect_device.jpg \
    --infrared suspect_device_ir.jpg

# 输出：残差热力图显示局部高温异常
# 结论：需要维修！
```

### 场景2：批量分析（高级流程）

```bash
# 数据科学家需要分析1000张图像，按异常程度排序
python train_anomaly_detector.py \
    --checkpoint final_model.pth \
    --method density

# 然后对所有图像评分
for img in *.jpg; do
    python inference.py --checkpoint final_model.pth --visible $img
done | sort -k2 -nr > ranked_anomalies.txt

# 输出：按异常分数排序的列表
```

---

## 总结

| | 基础流程 | 高级流程 |
|---|---|---|
| **步骤** | 3步 | 4步 |
| **必需脚本** | prepare_data.py<br>train_model.py<br>inference.py | + train_anomaly_detector.py |
| **训练时间** | ~5-7小时 | +30分钟 |
| **使用场景** | 日常巡检、快速判断 | 科研、精细分析 |
| **推荐度** | ⭐⭐⭐⭐⭐ | ⭐⭐⭐ |

**建议**：先用基础流程，如果效果不够再考虑高级流程！

---

## FAQ

**Q: 我必须运行 train_anomaly_detector.py 吗？**  
A: ❌ 不需要！inference.py 已经可以检测异常。

**Q: Phase C 能提升多少性能？**  
A: 约 5-10% 的 AUC 提升，但需要额外训练时间。

**Q: 如果我只想看热力图，用哪个？**  
A: inference.py 就够了！

**Q: 两个都运行会冲突吗？**  
A: 不会，train_anomaly_detector.py 只是保存额外的检测器模型。

**Q: 我该从哪个开始？**  
A: 从基础流程开始！先跑通再优化。

