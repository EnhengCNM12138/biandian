# 创新点2模型架构（文字版示意）

适用于当前 `train_model.py` 实现的跨模态可见光→红外生成系统，采用内容-风格解耦、物理调制与域对齐三大模块，整体训练分为 Phase A（重构）与 Phase B（对齐微调）。

```
可见光图像 V ──►┌────────────────────┐─┬─► c1/c2/c3 ────────┬──────────────┐
(RGB 3×H×W)     │ 内容编码器 E_c (共享)│ │                  │              │
                │ Conv↓×3 + ResBlocks │ │                  │              │
                └────────────────────┘ │                  │              │
                                       │                  │              │
                                       │                  │              │
红外图像 IR (训练) ──► 复制至3通道 ─┬─┘                  │              │
(灰度 1×H×W)                          │                    │              │
                                      │                    │              │
                                      │                    ▼              │
                                      │            ┌──────────────────┐   │
                                      │            │ 红外风格编码器 E_ir│   │
                                      │            │ Conv×3 + GAP + FC │   │
                                      │            └─────────┬────────┘   │
                                      │                      │ 风格向量   │
                                      │                      ▼ token化    │
                                      │                    ┌────────────────────┐
                                      │                    │   风格tokens (8×64) │
                                      │                    └─────────┬──────────┘
                                      │                              │
                                      │                              ▼
                                      │                       ┌───────────────┐
                                      │                       │ CrossAttention│
                                      │                       └───────────────┘
                                      │                              │
环境元数据 env ──► PhysicsFiLM ───────┴───────────┐          │
 (距离/湿度/温度/天气/风速)                        │          │
                                                  ▼          │
                                        ┌──────────────────────────────┐
                                        │   红外解码器 G_ir             │
                                        │   • 双线性上采样 ×3          │
                                        │   • SPADE(内容跳连)          │
                                        │   • PhysicsFiLM 调制         │
                                        │   • CrossAttention 风格注入  │
                                        └──────────────┬───────────────┘
                                                       │
                                                       ▼
                                               生成红外 ĨR
                                                       │
                                                       ▼
                                                Residual = |ĨR - IR|
                                                       │
                              ┌────────────────────────┴────────────────────────┐
                              │             重构 / 残差 / 高频损失               │
                              └──────────────────────────────────────────────────┘

                     ┌──────────────┐     α(p)       ┌──────────────┐
                     │ 内容特征 c3  │ ─────────────► │ 梯度反转层 GRL│
                     └──────────────┘                └──────┬───────┘
                                                           ▼
                                                 ┌──────────────────┐
                                                 │ 域判别器 D_domain │
                                                 │ FC×3 + Dropout    │
                                                 └─────────┬────────┘
                                                           ▼
                                                     域对抗损失

                     InfoNCE / MMD / 边缘损失  (Phase B 可选启用)

推理阶段：若无真实红外输入，使用可见风格编码器 E_v 生成风格向量并沿同一路径解码。
```

### 关键点摘要

- **内容编码器 E_c**：对可见光和红外图像共享参数，输出多尺度特征用于跳连与域对齐。
- **风格编码器 E_v / E_ir**：将模态特定的辐射特性编码成 256 维向量；训练期主要使用 `E_ir`，推理期可退化为 `E_v`。
- **红外解码器 G_ir**：融合内容跳连、风格 token 与环境向量，逐级上采样生成红外图像。
- **PhysicsFiLM**：利用环境元数据（距离、湿度、温度等）产生通道级 γ/β，用于物理一致性调制。
- **CrossAttention**：将风格向量拆解为 token，对内容特征执行多头注意力，实现跨谱风格注入。
- **GRL + 域判别器**：在训练中对内容特征施加域对抗，推动可见光与红外的结构特征对齐。
- **损失组合**：
  - Phase A：L2 / Charbonnier / MS-SSIM / Laplacian / Edge-Weighted L1 等重构项。
  - Phase B（若启用）：梯度、高频、InfoNCE、域对抗、MMD 等对齐项。
- **残差检测**：生成红外与真实红外的差分直接用于故障热区定位，也可作为 Phase C 的输入。

通过上述结构，本脚本实现了从配对可见光-红外数据中学习跨模态映射，并在保持几何一致性的同时融入环境先验与对齐约束，便于后续的异常检测任务。

